# Сервис сбора метрик и алертинга «Runlytics»

## Функционал

Агент собирает метрики из пакета `runtime` + `RandomValue и PollCount` и отправляет их на сервер по протоколу HTTP.

Сервер сохраняет полученные метрики от агента в памяти и файле или в базе данных.

## Агент

Собирает метрики двух типов:
- `gauge` - тип `float64`
- `counter` - тип `int64`

### Список метрик типа `gauge`

- `RandomValue` — обновляемое произвольное значение
- `Alloc`
- `BuckHashSys`
- `Frees`
- `GCCPUFraction`
- `GCSys`
- `HeapAlloc`
- `HeapIdle`
- `HeapInuse`
- `HeapObjects`
- `HeapReleased`
- `HeapSys`
- `LastGC`
- `Lookups`
- `MCacheInuse`
- `MCacheSys`
- `MSpanInuse`
- `MSpanSys`
- `Mallocs`
- `NextGC`
- `NumForcedGC`
- `NumGC`
- `OtherSys`
- `PauseTotalNs`
- `StackInuse`
- `StackSys`
- `Sys`
- `TotalAlloc`

### Список метрик типа `counter`

- `PollCount` — счётчик, увеличивающийся на 1 при каждом обновлении метрики из пакета `runtime`

### Конфигурирование Агента

Агент поддерживает конфигурирование следующими флагами и переменными:

- URL адрес сервера сбора метрик: переменная окружения `ADDRESS` или флаг `-a` (по умолчанию `http://localhost:8080`)
- ключ для хэширования запроса: переменная окружения `KEY` или флаг `-k` (по умолчанию не задан)
- уровень логирования: переменная окружения `LOG_LVL` или флаг `-log` (по умолчанию `info`)
- интервал сбора метрик в секундах: переменная окружения `POLL_INTERVAL` или флаг `-p` (по умолчанию `2`)
- интервал отправки метрик на сервер в секундах: переменная окружения `REPORT_INTERVAL` или флаг `-r` (по умолчанию `10`)
- количество воркер отправки метрик на сервер: переменная окружения `RATE_LIMIT` или флаг `-l` (по умолчанию `1`)


## Сервер

### Сводное HTTP API Сервера

* `GET /ping` - хелсчек
* `GET /` - получение списка метрик в виде html страницы
* `GET /value/{type}/{name}` - получение метрики по типу и назнванию
* `POST /value/` - получение метрики по типу и названию, запрос в формате `json`
* `POST /update/{type}/{name}/{value}` - запись/обновление метрики
* `POST /update/` - запись/обновление метрики, запрос в формате `json`
* `POST /updates/` - запись/обновление списка метрик, запрос в формате `json`

Все энпоинты поддерживают `gzip` сжатие

### Пинг сервера (хелсчек)

`GET /ping`

Формат запроса:

```
GET /ping HTTP/1.1
```

Коды ответа:

- `200` — успешная обработка запроса
- `500` — внутренняя ошибка сервера


### Получение списка метрик в виде html страницы

`GET /`

Формат запроса:

```
GET / HTTP/1.1
```

Коды ответа:

- `200` — успешная обработка запроса
- `500` — внутренняя ошибка сервера


### Получение значения метрики по типу и назнванию

`GET /value/{type}/{name}`

Формат запроса:

```
GET /value/gauge/TotalAlloc HTTP/1.1
```

Коды ответа:
- `200` - успешная обработка запроса
    
    Формат ответа:
    ```
    200 OK HTTP/1.1
    Content-Type: text/plain
    ...
    123.45
    ```
- `400` - неверный тип или отсутствует название метрики
- `404` - метрика не найдена
- `500` - внутренняя ошибка сервера


### Получение метрики по типу и названию, запрос в формате `json`

`POST /value/`

Формат запроса:

```
POST /value/ HTTP/1.1
...
{
    "id": "TotalAlloc",
    "type": "gauge"
}
```

Коды ответа:
- `200` - успешная обработка запроса

    Формат ответа:
    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    {
        "id": "TotalAlloc",
        "type": "gauge",
        "value": 123.45
    }
    ```

- `400` - невалидный `json` объект, неверный тип или отсутствует название метрики
- `404` - метрика не найдена
- `500` - внутренняя ошибка сервера


### Запись/обновление метрики

`POST /update/{type}/{name}/{value}`

Формат запроса:

```
POST /update/gauge/TotalAlloc/123.45 HTTP/1.1
```

Коды ответа:
- `200` - успешная обработка запроса

    Формат ответа:
    ```
    200 OK HTTP/1.1
    Content-Type: text/plain
    ...
    OK
    ```

- `400` - неверный тип или отсутствует название, значение метрики
- `500` - внутренняя ошибка сервера

### Запись/обновление метрики, запрос в формате `json`

`POST /update/`

Формат запроса:

```
POST /update/ HTTP/1.1
Content-Type: application/json
HashSHA256: <body_hash_sum>
...
{
    "id": "TotalAlloc",
    "type": "gauge", // gauge или counter
    "delta": 123, // обязательно для типа counter
    "value": 123.45 // обязательно для типа gauge
}
```

Коды ответа:
- `200` - успешная обработка запроса

    Формат ответа:
    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    {
        "id": "TotalAlloc",
        "type": "gauge", // gauge или counter
        "delta": 123, // для типа counter
        "value": 123.45 // для типа gauge
    }
    ```

- `400` - невалидный `json` объект, неверный тип или отсутствует название, значение метрики, несоответствует хэш сумма
- `500` - внутренняя ошибка сервера


### Запись/обновление списка метрик, запрос в формате `json`

`POST /updates/`

Формат запроса:

```
POST /updates/ HTTP/1.1
Content-Type: application/json
HashSHA256: <body_hash_sum>
...
[
    {
        "id": "TotalAlloc",
        "type": "gauge", 
        "value": 123.45
    },
    ...
    {
        "id": "PollCount",
        "type": "counter", 
        "value": 123
    }
]
```

Коды ответа:
- `200` - успешная обработка запроса

    Формат ответа:
    ```
    200 OK HTTP/1.1
    Content-Type: text/plain
    ...
    OK
    ```

- `400` - невалидный `json` объект, неверный тип или отсутствует название, значение метрики, несоответствует хэш сумма
- `500` - внутренняя ошибка сервера


### Конфигурирование Сервера

Сервер поддерживает конфигурирование следующими флагами и переменными:

- адрес и порт прослушиваемого сервером: переменная окружения `ADDRESS` или флаг `-a` (по умолчанию `localhost:8080`)
- ключ хэширования для проверки запроса от агента: переменная окружения `KEY` или флаг `-k` (по умолчанию не задан)
- уровень логирования: переменная окружения `LOG_LVL` или флаг `-log` (по умолчанию `info`)
- сохранение метрик в памяти и файле:
    - путь к файлу: переменная окружения `FILE_STORAGE_PATH` или флаг `-f` (по умолчанию `{project_dir}\storage.json`)
    - интервал (в секундах) сохранения метрик из памяти в файл: переменная окружения `STORE_INTERVAL` или флаг `-i` (по умолчанию `300`)
    - признак восстановления метрик из файла в память при запуске сервера: переменная окружения `RESTORE` или флаг `-r` (по умолчанию `1`)
- сохранение метрик в базе данных:
    - адрес подключения к базе данных: переменная окружения `DATABASE_DSN` или флаг `-d` (по умолчанию не задан)
